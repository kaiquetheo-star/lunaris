<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunaris Sessions</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=VT323&display=swap" rel="stylesheet">
    <style>
        /* RESET E FIX DO RET√ÇNGULO AZUL */
        * { -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; background-color: #000; font-family: 'VT323', monospace; overflow: hidden; color: #fff; }
        
        .bg-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 1.2s ease-in-out; opacity: 0; }
        video.active { opacity: 1; z-index: 1; }

        .ui-layer { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100vh; pointer-events: none; transition: opacity 0.8s; }
        .ui-layer.cutscene-ativa { opacity: 0; }
        .ui-layer * { pointer-events: auto; }

        .header-bar { display: flex; justify-content: space-between; padding: 15px 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); }
        .wallet { font-size: 24px; color: #ffd700; display: flex; align-items: center; gap: 8px; }

        .status-panel { padding: 0 20px; width: calc(100% - 40px); }
        .stat-row { display: flex; align-items: center; margin-bottom: 6px; gap: 10px; }
        .stat-label { font-size: 14px; color: #d8b4fe; min-width: 45px; text-shadow: 1px 1px 2px #000; }
        .bar-bg { flex-grow: 1; height: 4px; background: rgba(0,0,0,0.5); border-radius: 2px; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.5s; box-shadow: 0 0 8px currentColor; }

        .timer-hud { margin-top: 20px; text-align: center; }
        .timer-display { font-size: 60px; color: #d8b4fe; text-shadow: 0 0 10px #b026ff, 2px 2px 4px #000; }
        .btn-main { background: rgba(176, 38, 255, 0.3); border: 1px solid rgba(255,255,255,0.4); color: #fff; padding: 10px 25px; font-family: 'VT323', monospace; font-size: 20px; border-radius: 6px; cursor: pointer; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); }

        .mixer-dock { margin-top: auto; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
        .mixer-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        input[type=range] { flex-grow: 1; -webkit-appearance: none; background: rgba(255,255,255,0.1); height: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ff26a5; cursor: pointer; }

        /* MODAIS E MEDALHAS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #150a21; border: 1px solid #ff26a5; padding: 25px; border-radius: 12px; width: 85%; max-width: 450px; max-height: 85vh; overflow-y: auto; color: #fff; }
        .loja-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 12px; border-radius: 8px; border-left: 3px solid #b026ff; }
        
        .medal-container { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .medal-icon { width: 45px; height: 45px; opacity: 0.2; filter: grayscale(1); transition: 0.5s; border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; background: #2a114d; }
        .medal-icon.unlocked { opacity: 1; filter: grayscale(0); border-color: #ffd700; box-shadow: 0 0 10px #ffd700; background: #4a1d8a; }

        #diario-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; justify-content: center; align-items: end; }
        .papel-carta { background: #f4e4bc; color: #2c1a0b; width: 100%; height: 85vh; padding: 40px 30px; border-top-left-radius: 30px; border-top-right-radius: 30px; font-family: 'Dancing Script', cursive; font-size: 24px; line-height: 1.6; overflow-y: auto; transform: translateY(100%); transition: transform 0.6s ease; }
        #aviso-sistema { position: absolute; top: 110px; width: 100%; text-align: center; color: #ff26a5; font-size: 20px; opacity: 0; transition: 0.5s; z-index: 50; pointer-events: none; }
    </style>
</head>
<body>
    <audio id="audio-chuva" src="chuva.mp3" loop></audio>
    <audio id="audio-ronronar" src="ronronar.mp3" loop></audio>
    <audio id="audio-lofi"></audio>

    <div class="bg-container">
        <video id="videoA" class="active" autoplay loop muted playsinline src="vibe.mp4"></video>
        <video id="videoB" loop muted playsinline src=""></video>
    </div>

    <div id="aviso-sistema">Aviso</div>

    <div id="main-ui" class="ui-layer">
        <div class="header-bar">
            <div class="wallet">ü™ô <span id="display-moedas">0</span></div>
            <button class="btn-main" style="font-size: 14px; padding: 5px 15px;" onclick="abrirLoja()">LOJA & DI√ÅRIO</button>
        </div>

        <div class="status-panel">
            <div class="stat-row"><div class="stat-label">VIBE</div><div class="bar-bg"><div class="bar-fill" id="bar-vibe" style="background:#ff26a5;"></div></div></div>
            <div class="stat-row"><div class="stat-label">SONO</div><div class="bar-bg"><div class="bar-fill" id="bar-sono" style="background:#26d0ff;"></div></div></div>
            <div class="stat-row"><div class="stat-label">FOME</div><div class="bar-bg"><div class="bar-fill" id="bar-fome" style="background:#ffb826;"></div></div></div>
        </div>

        <div class="timer-hud">
            <div id="status-texto" style="font-size: 14px; color: #a87ffb; margin-bottom: -5px;">PRONTO?</div>
            <div class="timer-display" id="tempo">25:00</div>
            <button class="btn-main" id="btn-acao" onclick="toggleFocus()">INICIAR FOCO</button>
        </div>

        <div class="mixer-dock">
            <div class="mixer-row"><span>üåßÔ∏è</span><input type="range" value="50" oninput="ajustarVol('chuva', this.value)"></div>
            <div class="mixer-row"><span>üê±</span><input type="range" id="vol-ronrono" value="0" oninput="ajustarVol('ronronar', this.value)"></div>
            <div class="mixer-row"><span>üéß</span><input type="range" value="30" oninput="ajustarVol('lofi', this.value)"></div>
            <div id="now-playing" style="font-size: 12px; opacity: 0.6; text-align: right; margin-top:5px;">Tocando: Fita #1</div>
        </div>
    </div>

    <div id="loja-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: #ff26a5; margin-top: 0; border-bottom: 1px solid #3b1b63; padding-bottom: 10px;">üõí Loja & Di√°rio</h2>
            <div class="loja-item"><span>Sach√™ üêü</span><button class="btn-main" style="font-size: 16px;" onclick="comprarSache()">20 ü™ô</button></div>
            <div class="loja-item"><span>Nova Fita üìº</span><button class="btn-main" style="font-size: 16px;" onclick="comprarMusica()">100 ü™ô</button></div>
            
            <h3 style="color: #26d0ff; margin-top: 20px; font-size: 18px;">üèÖ Medalhas</h3>
            <div class="medal-container" id="medal-list">
                <div class="medal-icon" id="medal-0">üå±</div>
                <div class="medal-icon" id="medal-1">üêü</div>
                <div class="medal-icon" id="medal-2">üé∂</div>
                <div class="medal-icon" id="medal-3">üìñ</div>
            </div>

            <h3 style="color: #26d0ff; margin-top: 25px;">üìñ Di√°rio</h3>
            <div id="area-compra-diario"></div>
            <div id="diario-lido" style="margin-top: 10px; display: flex; flex-direction: column; gap: 8px;"></div>
            <button class="btn-main" style="width:100%; background: #333; margin-top: 20px; border:none;" onclick="fecharLoja()">FECHAR</button>
        </div>
    </div>

    <div id="diario-overlay">
        <div class="papel-carta" id="papel-conteudo">
            <button style="position:absolute; top:20px; right:20px; background:none; border:none; font-size:30px; cursor:pointer;" onclick="fecharPaginaDiario()">X</button>
            <div id="texto-diario-final"></div>
        </div>
    </div>

    <script>
        const VIDEO_SPEED = 0.6;
        const TEMPO_CICLO = 25 * 60;
        
        let moedas = parseInt(localStorage.getItem('lunaris_moedas')) || 0;
        let paginasDesbloqueadas = parseInt(localStorage.getItem('lunaris_paginas')) || 0;
        let sachesDados = parseInt(localStorage.getItem('lunaris_saches')) || 0;
        let ciclosFeitos = parseInt(localStorage.getItem('lunaris_ciclos')) || 0;
        let medalhas = JSON.parse(localStorage.getItem('lunaris_medalhas')) || [false, false, false, false];

        let stats = { 
            vibe: parseInt(localStorage.getItem('lunaris_vibe')) || 100, 
            sono: parseInt(localStorage.getItem('lunaris_sono')) || 100, 
            fome: parseInt(localStorage.getItem('lunaris_fome')) || 100 
        };

        let tempoRestante = TEMPO_CICLO;
        let timerIntervalo = null;
        let emFoco = false;

        const baseTracks = ['track1.mp3', 'track2.mp3', 'track3.mp3', 'track4.mp3'];
        let unlockedTracks = JSON.parse(localStorage.getItem('lunaris_tracks')) || [];
        let playlist = [...baseTracks, ...unlockedTracks];
        let currentTrackIndex = 0;

        const audios = {
            chuva: document.getElementById('audio-chuva'),
            ronronar: document.getElementById('audio-ronronar'),
            lofi: document.getElementById('audio-lofi')
        };

        const paginasDiario = [
            { custo: 30, texto: "Dia 1. A chuva n√£o para faz semanas e sua falta √© esmagadora. N√£o sei o que pesa mais, o c√©u cinza l√° fora ou o sil√™ncio insuport√°vel aqui dentro. Hoje, deixei a janela entreaberta para sentir o vento e ele entrou. Um gato preto, com olhos de lua. Ele n√£o miou, n√£o pediu nada. S√≥ deitou na minha coberta roxa e dormiu. Acho que n√≥s dois est√°vamos precisando de um lugar seguro." },
            { custo: 60, texto: "Dia 12. A depress√£o √© um bicho estranho. Ela te convence de que voc√™ √© invis√≠vel e te rouba a vontade de levantar da cama. Mas o Lunaris n√£o deixa. Ele me acorda todos os dias empurrando o potinho vazio pelo ch√£o. Levantar para alimentar ele me obriga a ficar de p√©. √â um passo pequeno, eu sei. Mas hoje, foi o suficiente." },
            { custo: 100, texto: "Dia 28. Coloquei um disco antigo pra tocar hoje. Fazia meses que eu n√£o ouvia m√∫sica, desde que tudo aconteceu. O Lunaris pulou no parapeito da janela e ficou balan√ßando o rabo no ritmo dos graves. A dor no peito ainda est√° aqui, latejando devagar... mas pela primeira vez em muito tempo, o apartamento n√£o pareceu t√£o vazio." },
            { custo: 130, texto: "Dia 45. Encontrei meu caderno de composi√ß√µes debaixo da cama hoje. O Lunaris sentou em cima dele antes que eu pudesse fechar. Escrevi apenas tr√™s frases sobre o tom de roxo que o c√©u fica √†s seis da tarde. Minhas m√£os tremeram, mas ele come√ßou a ronronar t√£o alto que o medo diminuiu. Acho que ele gosta de poesia." },
            { custo: 160, texto: "Dia 60. Tive uma reca√≠da hoje. O peso nas costas voltou e o sil√™ncio pareceu amargo de novo. Fiquei horas olhando para a parede. Ent√£o senti algo macio no meu rosto. O Lunaris trouxe aquele ratinho de feltro velho e o soltou no meu travesseiro. Ele n√£o sabe o que √© depress√£o, mas ele sabe quando eu preciso de um amigo. Levantei s√≥ para brincar com ele." },
            { custo: 190, texto: "Dia 85. A chuva finalmente deu uma tr√©gua e um raio de sol p√°lido cortou o tapete. O Lunaris perseguiu a poeira dan√ßando na luz como se fosse a coisa mais importante do universo. Fiquei observando e percebi que tamb√©m estou aprendendo a ca√ßar meus pr√≥prios raios de sol. O EP est√° ganhando corpo. As batidas agora soam como batimentos card√≠acos." },
            { custo: 250, texto: "Dia 110. Terminei a faixa principal hoje. Batizei de 'Orbital'. Enquanto eu mixava os sintetizadores, o Lunaris dormia em cima da minha placa de som. O calor dos aparelhos e o som lo-fi parecem o habitat natural dele. Pela primeira vez em um ano, n√£o me sinto sozinha neste quarto. Somos uma banda de dois." },
            { custo: 300, texto: "Olhei no espelho e vi que meus olhos est√£o um pouco mais brilhantes. O Lunaris estava ao meu lado, refletido tamb√©m. Ele √© o guardi√£o dos meus segredos e o coautor da minha paz. A m√∫sica que antes era um grito de dor, agora √© um abra√ßo morno. O quarto roxo n√£o √© mais uma gaiola; √© o nosso santu√°rio." }
        ];

        let vA = document.getElementById('videoA'); 
        let vB = document.getElementById('videoB'); 
        vA.playbackRate = VIDEO_SPEED;

        function mostrarAviso(txt) {
            const av = document.getElementById('aviso-sistema');
            av.innerText = txt; av.style.opacity = 1;
            setTimeout(() => av.style.opacity = 0, 3000);
        }

        function ajustarVol(tipo, valor) {
            const player = audios[tipo];
            const v = valor / 100;
            player.volume = v;
            localStorage.setItem('lunaris_vol_' + tipo, v);
            // Sync slider UI if changed programmatically
            const sliderId = tipo === 'ronronar' ? 'vol-ronrono' : null;
            if (sliderId && document.getElementById(sliderId)) {
                document.getElementById(sliderId).value = valor;
            }
            if (player.paused && player.volume > 0) player.play().catch(e => {});
        }

        function trocarCena(novaSrc) {
            // Prevent unnecessary transition if already showing
            if (vA.src.includes(novaSrc)) return;
            // Prepare next video
            vB.src = novaSrc;
            vB.playbackRate = VIDEO_SPEED;
            vB.currentTime = 0;
            vB.style.transition = 'opacity 1.2s ease-in-out';
            vB.style.opacity = 0;
            vB.load();
            vB.oncanplay = () => {
                vB.oncanplay = null;
                vB.play().then(() => {
                    // Crossfade
                    vB.classList.add('active');
                    vA.classList.remove('active');
                    vB.style.opacity = 1;
                    vA.style.opacity = 0;
                    // Swap references after transition
                    setTimeout(() => {
                        let temp = vA; vA = vB; vB = temp;
                        // Clean up inactive video
                        vB.classList.remove('active');
                        vB.style.opacity = 0;
                        vB.src = '';
                    }, 1200);
                }).catch(() => {});
            };
        }

        function atualizarUI() {
            document.getElementById('display-moedas').innerText = moedas;
            document.getElementById('bar-vibe').style.width = stats.vibe + '%';
            document.getElementById('bar-sono').style.width = stats.sono + '%';
            document.getElementById('bar-fome').style.width = stats.fome + '%';
            
            if(ciclosFeitos >= 1) medalhas[0] = true;
            if(sachesDados >= 5) medalhas[1] = true;
            if(unlockedTracks.length >= 1) medalhas[2] = true;
            if(paginasDesbloqueadas >= 3) medalhas[3] = true;

            medalhas.forEach((m, i) => { if(m) document.getElementById('medal-'+i).classList.add('unlocked'); });

            localStorage.setItem('lunaris_moedas', moedas);
            localStorage.setItem('lunaris_paginas', paginasDesbloqueadas);
            localStorage.setItem('lunaris_saches', sachesDados);
            localStorage.setItem('lunaris_ciclos', ciclosFeitos);
            localStorage.setItem('lunaris_vibe', stats.vibe);
            localStorage.setItem('lunaris_sono', stats.sono);
            localStorage.setItem('lunaris_fome', stats.fome);
        }

        function toggleFocus() {
            if (!emFoco) {
                emFoco = true;
                document.getElementById('btn-acao').innerText = "DESISTIR";
                document.getElementById('status-texto').innerText = "LUNARIS DORMINDO...";
                trocarCena("dormindo.mp4");
                timerIntervalo = setInterval(() => {
                    tempoRestante--;
                    atualizarRelogio();
                    if (tempoRestante <= 0) finalizar();
                }, 1000);
            } else { location.reload(); }
        }

        function finalizar() {
            clearInterval(timerIntervalo); timerIntervalo = null; emFoco = false;
            moedas += 25; ciclosFeitos++; stats.sono = 100; tempoRestante = TEMPO_CICLO;
            atualizarRelogio(); atualizarUI();
            document.getElementById('btn-acao').innerText = "NOVO CICLO";
            document.getElementById('status-texto').innerText = "PRONTO?";
            trocarCena("vibe.mp4");
        }

        function comprarSache() {
            if (moedas >= 20) {
                moedas -= 20; sachesDados++; stats.fome = 100;
                atualizarUI(); fecharLoja();
                if (navigator.vibrate) navigator.vibrate(200);
                
                // MUDAN√áA AQUI: Texto avisando que est√° comendo
                document.getElementById('status-texto').innerText = "LUNARIS COMENDO...";
                document.getElementById('main-ui').classList.add('cutscene-ativa');
                trocarCena("comendo.mp4");
                
                setTimeout(() => {
                    trocarCena("vibe.mp4");
                    document.getElementById('main-ui').classList.remove('cutscene-ativa');
                    // Fix: Always update status-texto based on current emFoco state
                    if (emFoco) {
                        document.getElementById('status-texto').innerText = "LUNARIS DORMINDO...";
                    } else {
                        document.getElementById('status-texto').innerText = "PRONTO?";
                    }
                }, 6000);
            } else { mostrarAviso("Moedas insuficientes!"); }
        }

        function renderizarLoja() {
            const areaCompra = document.getElementById('area-compra-diario'); const areaLido = document.getElementById('diario-lido');
            areaCompra.innerHTML = ''; areaLido.innerHTML = '';
            for (let i = 0; i < paginasDesbloqueadas; i++) { areaLido.innerHTML += `<button class="btn-main" style="font-size:14px; width:100%; margin-bottom:5px;" onclick="abrirPagina(${i})">üìñ P√°gina ${i+1}</button>`; }
            if (paginasDesbloqueadas < paginasDiario.length) {
                let p = paginasDiario[paginasDesbloqueadas];
                areaCompra.innerHTML = `<div class="loja-item"><span>P√°gina ${paginasDesbloqueadas+1}</span><button class="btn-main" onclick="comprarPagina(${p.custo})">${p.custo} ü™ô</button></div>`;
            }
        }

        function abrirLoja() { renderizarLoja(); document.getElementById('loja-modal').style.display = 'flex'; }
        function fecharLoja() { document.getElementById('loja-modal').style.display = 'none'; }
        function comprarPagina(custo) { if (moedas >= custo) { moedas -= custo; paginasDesbloqueadas++; atualizarUI(); renderizarLoja(); } }
        function abrirPagina(i) { fecharLoja(); document.getElementById('texto-diario-final').innerText = paginasDiario[i].texto; document.getElementById('diario-overlay').style.display = 'flex'; setTimeout(() => document.getElementById('papel-conteudo').style.transform = 'translateY(0)', 10); }
        function fecharPaginaDiario() { document.getElementById('papel-conteudo').style.transform = 'translateY(100%)'; setTimeout(() => document.getElementById('diario-overlay').style.display = 'none', 600); }

        function atualizarRelogio() {
            let m = Math.floor(tempoRestante / 60); let s = tempoRestante % 60;
            document.getElementById('tempo').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // Status drain logic: Fome and Vibe always drain. Sono only drains when not focusing. Managed interval to prevent leaks.
        let drainInterval = null;
        function startDrainInterval() {
            if (drainInterval) clearInterval(drainInterval);
            drainInterval = setInterval(() => {
                stats.fome = Math.max(0, stats.fome - 1);
                stats.vibe = Math.max(0, stats.vibe - 1);
                if (!emFoco) {
                    stats.sono = Math.max(0, stats.sono - 1);
                } // else: optionally replenish sleep
                atualizarUI();
                // Always persist stats after update
                localStorage.setItem('lunaris_vibe', stats.vibe);
                localStorage.setItem('lunaris_sono', stats.sono);
                localStorage.setItem('lunaris_fome', stats.fome);
            }, 60000);
        }
        startDrainInterval();

        function iniciarPlaylist() {
            audios.lofi.src = playlist[currentTrackIndex];
            // Restore persisted volume or default
            let v = parseFloat(localStorage.getItem('lunaris_vol_lofi'));
            if (isNaN(v)) v = 0.3;
            audios.lofi.volume = v;
            document.getElementById('now-playing').innerText = "Tocando: Fita #" + (currentTrackIndex + 1);
            audios.lofi.play().catch(e => {});
        }

        audios.lofi.addEventListener('ended', () => {
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            audios.lofi.src = playlist[currentTrackIndex];
            // Restore persisted volume
            let v = parseFloat(localStorage.getItem('lunaris_vol_lofi'));
            if (isNaN(v)) v = 0.3;
            audios.lofi.volume = v;
            document.getElementById('now-playing').innerText = "Tocando: Fita #" + (currentTrackIndex + 1);
            audios.lofi.play();
        });

        document.addEventListener('click', () => { 
            if(audios.lofi.paused) iniciarPlaylist();
            Object.keys(audios).forEach(key => { if(audios[key].volume > 0) audios[key].play().catch(e => {}); });
        }, { once: true });

        // Restore audio volumes and sliders on load
        window.addEventListener('DOMContentLoaded', () => {
            const volChuva = parseFloat(localStorage.getItem('lunaris_vol_chuva'));
            if (!isNaN(volChuva)) {
                audios.chuva.volume = volChuva;
                document.querySelectorAll('input[type=range]')[0].value = Math.round(volChuva * 100);
            }
            const volRonronar = parseFloat(localStorage.getItem('lunaris_vol_ronronar'));
            if (!isNaN(volRonronar)) {
                audios.ronronar.volume = volRonronar;
                document.getElementById('vol-ronrono').value = Math.round(volRonronar * 100);
            }
            const volLofi = parseFloat(localStorage.getItem('lunaris_vol_lofi'));
            if (!isNaN(volLofi)) {
                audios.lofi.volume = volLofi;
                document.querySelectorAll('input[type=range]')[2].value = Math.round(volLofi * 100);
            }
        });

        // PR√äMIO DI√ÅRIO
        function verificarRecompensaDiaria() {
            const hoje = new Date().toISOString().split('T')[0];
            const ultima = localStorage.getItem('lunaris_recompensa_data');
            if (ultima !== hoje) {
                moedas += 50; localStorage.setItem('lunaris_recompensa_data', hoje);
                atualizarUI(); setTimeout(() => mostrarAviso(`Presente Di√°rio: +50 ü™ô ‚ú®`), 2000);
            }
        }

        atualizarUI(); atualizarRelogio(); verificarRecompensaDiaria();
        // REGISTRO DO SERVICE WORKER
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
            .then(reg => console.log('Lunaris Offline Pronto!', reg))
            .catch(err => console.log('Erro no Service Worker', err));
    });
}
   </script>
</body>
</html>